<view class="container">
  <!-- æ ‡ç­¾æ  -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === 'overview' ? 'active' : ''}}"
      data-tab="overview"
      bindtap="handleTabChange"
    >
      æ€»è§ˆ
    </view>
    <view 
      class="tab-item {{activeTab === 'chat' ? 'active' : ''}}"
      data-tab="chat"
      bindtap="handleTabChange"
    >
      å¯¹è¯
    </view>
    <view 
      class="tab-item {{activeTab === 'robot' ? 'active' : ''}}"
      data-tab="robot"
      bindtap="handleTabChange"
    >
      æœºå™¨äºº
    </view>
    <view 
      class="tab-item {{activeTab === 'evaluation' ? 'active' : ''}}"
      data-tab="evaluation"
      bindtap="handleTabChange"
    >
      è¯„ä»·
    </view>
    <view 
      class="tab-item {{activeTab === 'points' ? 'active' : ''}}"
      data-tab="points"
      bindtap="handleTabChange"
    >
      ç§¯åˆ†
    </view>
  </view>

  <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
  <view class="filter-bar">
    <picker 
      mode="selector"
      range="{{['æœ¬å‘¨', 'æœ¬æœˆ', 'æœ¬å¹´', 'è‡ªå®šä¹‰']}}"
      value="{{dateRange === 'week' ? 0 : dateRange === 'month' ? 1 : dateRange === 'year' ? 2 : 3}}"
      bindchange="handleRangeChange"
    >
      <view class="range-picker">
        <text>{{dateRange === 'week' ? 'æœ¬å‘¨' : dateRange === 'month' ? 'æœ¬æœˆ' : dateRange === 'year' ? 'æœ¬å¹´' : 'è‡ªå®šä¹‰'}}</text>
        <text class="arrow">â–¼</text>
      </view>
    </picker>

    <block wx:if="{{dateRange === 'custom'}}">
      <picker 
        mode="date"
        value="{{customStart}}"
        data-type="customStart"
        bindchange="handleDateChange"
      >
        <view class="date-picker">
          <text>{{customStart || 'å¼€å§‹æ—¥æœŸ'}}</text>
        </view>
      </picker>
      <text class="date-separator">è‡³</text>
      <picker 
        mode="date"
        value="{{customEnd}}"
        data-type="customEnd"
        bindchange="handleDateChange"
      >
        <view class="date-picker">
          <text>{{customEnd || 'ç»“æŸæ—¥æœŸ'}}</text>
        </view>
      </picker>
    </block>

    <button 
      class="export-btn"
      bindtap="handleExport"
    >
      å¯¼å‡º
    </button>
  </view>

  <!-- ç»Ÿè®¡å†…å®¹ -->
  <view class="stats-content">
    <!-- æ€»è§ˆ -->
    <view class="stats-section" wx:if="{{activeTab === 'overview' && stats.overview}}">
      <view class="stats-card">
        <view class="card-title">ç”¨æˆ·æ•°æ®</view>
        <view class="card-grid">
          <view class="grid-item">
            <text class="item-value">{{stats.overview.totalUsers}}</text>
            <text class="item-label">æ€»ç”¨æˆ·æ•°</text>
          </view>
          <view class="grid-item">
            <text class="item-value">{{stats.overview.activeUsers}}</text>
            <text class="item-label">æ´»è·ƒç”¨æˆ·</text>
          </view>
          <view class="grid-item">
            <text class="item-value">{{stats.overview.newUsers}}</text>
            <text class="item-label">æ–°å¢ç”¨æˆ·</text>
          </view>
        </view>
      </view>

      <view class="stats-card">
        <view class="card-title">å¯¹è¯æ•°æ®</view>
        <view class="card-grid">
          <view class="grid-item">
            <text class="item-value">{{stats.overview.totalChats}}</text>
            <text class="item-label">æ€»å¯¹è¯æ•°</text>
          </view>
          <view class="grid-item">
            <text class="item-value">{{stats.overview.avgChatsPerUser}}</text>
            <text class="item-label">äººå‡å¯¹è¯</text>
          </view>
          <view class="grid-item">
            <text class="item-value">{{stats.overview.satisfactionRate}}%</text>
            <text class="item-label">æ»¡æ„åº¦</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¯¹è¯ç»Ÿè®¡ -->
    <view class="stats-section" wx:if="{{activeTab === 'chat' && stats.chat}}">
      <view class="stats-card">
        <view class="card-title">å¯¹è¯è¶‹åŠ¿</view>
        <canvas 
          canvas-id="chatTrend"
          class="trend-chart"
          style="height: 400rpx;"
        />
        <view class="chart-legend">
          <view class="legend-item">
            <view class="legend-color" style="background: #1296db;"></view>
            <text>å¯¹è¯æ•°é‡</text>
          </view>
          <view class="legend-item">
            <view class="legend-color" style="background: #91d5ff;"></view>
            <text>æ´»è·ƒç”¨æˆ·</text>
          </view>
        </view>
      </view>

      <view class="stats-card">
        <view class="card-title">çƒ­é—¨é—®é¢˜</view>
        <view class="list-content">
          <view 
            class="list-item"
            wx:for="{{stats.chat.hotQuestions}}"
            wx:key="question"
          >
            <view class="item-rank">{{index + 1}}</view>
            <view class="item-main">
              <text class="item-title">{{item.question}}</text>
              <text class="item-count">{{item.count}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æœºå™¨äººç»Ÿè®¡ -->
    <view class="stats-section" wx:if="{{activeTab === 'robot' && stats.robot}}">
      <view class="stats-card">
        <view class="card-title">æœºå™¨äººä½¿ç”¨æƒ…å†µ</view>
        <canvas 
          canvas-id="robotUsage"
          class="pie-chart"
          style="height: 400rpx;"
        />
      </view>

      <view class="stats-card">
        <view class="card-title">æœºå™¨äººæ€§èƒ½</view>
        <view class="performance-list">
          <view class="performance-item">
            <text class="item-label">å¹³å‡å“åº”æ—¶é—´</text>
            <text class="item-value">{{stats.robot.avgResponseTime}}ms</text>
          </view>
          <view class="performance-item">
            <text class="item-label">å‡†ç¡®ç‡</text>
            <text class="item-value">{{stats.robot.accuracy}}%</text>
          </view>
          <view class="performance-item">
            <text class="item-label">çŸ¥è¯†åº“è¦†ç›–ç‡</text>
            <text class="item-value">{{stats.robot.coverage}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯„ä»·ç»Ÿè®¡ -->
    <view class="stats-section" wx:if="{{activeTab === 'evaluation' && stats.evaluation}}">
      <view class="stats-card">
        <view class="card-title">è¯„ä»·åˆ†å¸ƒ</view>
        <canvas 
          canvas-id="evaluationDist"
          class="bar-chart"
          style="height: 400rpx;"
        />
      </view>

      <view class="stats-card">
        <view class="card-title">è¯„ä»·åé¦ˆ</view>
        <view class="feedback-list">
          <view 
            class="feedback-item"
            wx:for="{{stats.evaluation.feedbacks}}"
            wx:key="id"
          >
            <view class="feedback-header">
              <text class="feedback-score">{{item.score === 1 ? 'ğŸ‘' : 'ğŸ‘'}}</text>
              <text class="feedback-time">{{item.time}}</text>
            </view>
            <view class="feedback-content">{{item.content}}</view>
            <view class="feedback-question">é—®é¢˜ï¼š{{item.question}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç§¯åˆ†ç»Ÿè®¡ -->
    <view class="stats-section" wx:if="{{activeTab === 'points' && stats.points}}">
      <view class="stats-card">
        <view class="card-title">ç§¯åˆ†è¶‹åŠ¿</view>
        <canvas 
          canvas-id="pointsTrend"
          class="trend-chart"
          style="height: 400rpx;"
        />
      </view>

      <view class="stats-card">
        <view class="card-title">ç§¯åˆ†æ’è¡Œ</view>
        <view class="rank-list">
          <view 
            class="rank-item"
            wx:for="{{stats.points.topUsers}}"
            wx:key="userId"
          >
            <view class="rank-index">{{index + 1}}</view>
            <image class="rank-avatar" src="{{item.avatar}}" />
            <view class="rank-info">
              <text class="rank-name">{{item.nickname}}</text>
              <text class="rank-points">{{item.points}}ç§¯åˆ†</text>
            </view>
          </view>
        </view>
      </view>

      <view class="stats-card">
        <view class="card-title">ç§¯åˆ†æ¶ˆè€—</view>
        <view class="points-usage">
          <canvas 
            canvas-id="pointsUsage"
            class="pie-chart"
            style="height: 300rpx;"
          />
          <view class="usage-legend">
            <view 
              class="legend-item"
              wx:for="{{stats.points.usage}}"
              wx:key="type"
            >
              <view class="legend-color" style="background: {{item.color}};"></view>
              <text>{{item.type}}</text>
              <text class="legend-value">{{item.value}}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view> 